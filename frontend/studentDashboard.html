<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Campus Flow</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' http://localhost:5000; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .welcome {
            font-size: 24px;
            color: #333;
        }
        .logout-btn {
            padding: 8px 16px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .logout-btn:hover {
            background-color: #c82333;
        }
        .dashboard-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .card h3 {
            margin-top: 0;
            color: #333;
        }
        .event-card {
            background: #fff;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .event-status {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .badge {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge-success {
            background-color: #28a745;
            color: white;
        }
        .badge-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .task-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .task-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .task-title {
            font-size: 1.1em;
            font-weight: bold;
        }
        .task-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .status-pending {
            background-color: #ffd700;
            color: #000;
        }
        .status-submitted {
            background-color: #28a745;
            color: white;
        }
        .status-late {
            background-color: #dc3545;
            color: white;
        }
        .task-details {
            margin: 10px 0;
            font-size: 0.9em;
            color: #666;
        }
        .task-actions {
            margin-top: 10px;
        }
        .submission-form {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .type-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-left: 8px;
        }
        .badge-document { background-color: #007bff; color: white; }
        .badge-form { background-color: #17a2b8; color: white; }
        .badge-hackathon { background-color: #ffc107; color: black; }
        .badge-quiz { background-color: #28a745; color: white; }
        .badge-project { background-color: #6c757d; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="welcome">Welcome, <span id="studentName">Student</span></div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
        <div class="dashboard-content">
            <div class="card">
                <h3>My Courses</h3>
                <p>View your enrolled courses and grades.</p>
            </div>
            <div class="card">
                <h3>Timetable</h3>
                <p>Check your weekly class schedule.</p>
            </div>
            <div class="card">
                <h3>Announcements</h3>
                <p>Read important updates from the administration.</p>
            </div>
            <div class="card">
                <h3>Profile</h3>
                <p>Update your student information.</p>
            </div>
            <div class="card">
                <h3>Upcoming Events</h3>
                <div id="eventsList">
                    <!-- Events will be loaded here -->
                </div>
            </div>
            <div class="card">
                <h3>My Tasks</h3>
                <div id="taskList"></div>
            </div>
        </div>
    </div>

    <script>
        // Check if user is logged in
        function checkAuth() {
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        // If no token or incorrect role, redirect to login
        if (!token || user.role !== 'student') {
            console.log('No token or incorrect role for student dashboard, redirecting to login.');
            window.location.replace('http://localhost:5000/login');
                return false;
            }
            return true;
        }

        // Initialize dashboard
        function initDashboard() {
            console.log('initDashboard called');
            if (!checkAuth()) return;

            const user = JSON.parse(localStorage.getItem('user') || '{}');
            console.log('User object from localStorage in initDashboard:', user);

        // Display student name if logged in
        if (user && user.name) {
            document.getElementById('studentName').textContent = user.name;
        }

            // Load tasks for student's class, passing the user object
            loadTasks(user);
        }

        // Load tasks
        async function loadTasks(user) {
            console.log('loadTasks called');
            try {
                console.log('User object received in loadTasks:', user);
                console.log('User class received in loadTasks:', user.class);

                if (!user || !user.class) {
                    console.error('User object or class is missing/undefined when loadTasks was called.');
                    const taskList = document.getElementById('taskList');
                    if (taskList) {
                        taskList.innerHTML = '<p>No class assigned to student. Please contact your administrator if you believe this is an error.</p>';
                    }
                    throw new Error('No class assigned to student');
                }

                const response = await fetch(`http://localhost:5000/api/tasks/class/${user.class}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status === 403) {
                         console.error('Access denied error from backend:', errorData.message);
                        throw new Error(errorData.message || 'Access denied');
                    }
                    throw new Error(errorData.message || 'Failed to fetch tasks');
                }

                const tasks = await response.json();
                console.log('Received tasks:', tasks); // Debug log

                const taskList = document.getElementById('taskList');
                if (!taskList) {
                    console.error('Task list element not found');
                    return;
                }

                // Clear existing tasks
                taskList.innerHTML = '';

                if (!tasks || !tasks.length) {
                    taskList.innerHTML = '<p>No tasks assigned yet.</p>';
                    return;
                }

                tasks.forEach(task => {
                    // Find student's submission for this task
                    const studentSubmission = task.submissions.find(
                        sub => sub.studentId && sub.studentId.toString() === user.id
                    );

                    // Set submission status
                    task.submissionStatus = studentSubmission ? studentSubmission.status : 'pending';

                    const taskItem = document.createElement('div');
                    taskItem.className = 'task-item card';
                    taskItem.innerHTML = `
                        <div class="task-header">
                            <div class="task-title">${task.title}${getTypeBadge(task.type)}</div>
                            <span class="task-status ${getStatusClass(task.submissionStatus)}">${task.submissionStatus}</span>
                        </div>
                        <div class="task-details">
                            <div>Class: ${task.class ? task.class.name : 'N/A'}</div>
                            <div>Teacher: ${task.teacherId?.name || 'Not assigned'}</div>
                            <div>Deadline: ${new Date(task.deadline).toLocaleString()}</div>
                            <div>Description: ${task.description}</div>
                            ${getTypeSpecificDetails(task)}
                        </div>
                        ${getSubmissionForm(task)}
                    `;
                    taskList.appendChild(taskItem);
                });
            } catch (error) {
                console.error('Error loading tasks:', error);
                const taskList = document.getElementById('taskList');
                if (taskList) {
                    taskList.innerHTML = `
                        <div class="alert alert-danger">
                            ${error.message}
                            ${error.message.includes('class') ? '<br>Please contact your administrator if you believe this is an error.' : ''}
                        </div>
                    `;
                } else {
                    console.error('Task list element not found for error display');
                }
            }
        }

        function getTypeBadge(type) {
            const badges = {
                document: '<span class="type-badge badge-document">Document</span>',
                form: '<span class="type-badge badge-form">Form</span>',
                hackathon: '<span class="type-badge badge-hackathon">Hackathon</span>',
                quiz: '<span class="type-badge badge-quiz">Quiz</span>',
                project: '<span class="type-badge badge-project">Project</span>'
            };
            return badges[type] || '';
        }

        function getStatusClass(status) {
            switch (status) {
                case 'submitted': return 'status-submitted';
                case 'late': return 'status-late';
                default: return 'status-pending';
            }
        }

        function getTypeSpecificDetails(task) {
            switch (task.type) {
                case 'form':
                    return `<div class="task-link"><a href="${task.formLink}" target="_blank">Form Link</a></div>`;
                case 'hackathon':
                    return `
                        <div class="hackathon-details">
                            <p>Platform: ${task.hackathonDetails.platform}</p>
                            <p>Duration: ${new Date(task.hackathonDetails.startDate).toLocaleDateString()} - ${new Date(task.hackathonDetails.endDate).toLocaleDateString()}</p>
                            <a href="${task.hackathonDetails.registrationLink}" target="_blank">Registration Link</a>
                        </div>
                    `;
                case 'quiz':
                    return `
                        <div class="quiz-details">
                            <p>Questions: ${task.quizDetails.totalQuestions}</p>
                            <p>Time Limit: ${task.quizDetails.timeLimit} minutes</p>
                            <p>Passing Score: ${task.quizDetails.passingScore}</p>
                            <a href="${task.quizDetails.quizLink}" target="_blank">Quiz Link</a>
                        </div>
                    `;
                case 'project':
                    return `
                        <div class="project-details">
                            <p><strong>Requirements:</strong> ${task.projectDetails.requirements}</p>
                            <p><strong>Deliverables:</strong> ${task.projectDetails.deliverables.join(', ')}</p>
                            <p><strong>Evaluation Criteria:</strong> ${task.projectDetails.evaluationCriteria.join(', ')}</p>
                        </div>
                    `;
                default:
                    return '';
            }
        }

        function getSubmissionForm(task) {
            if (task.submissionStatus === 'submitted' || task.submissionStatus === 'late') {
                return `<div class="task-actions">
                    <a href="/api/tasks/submission/${task._id}/${user.id}" class="btn btn-primary">View Submission</a>
                </div>`;
            }

            switch (task.type) {
                case 'document':
                    return `
                        <div class="submission-form">
                            <form onsubmit="submitTask(event, '${task._id}')">
                                <div class="form-group">
                                    <label for="submissionFile">Upload Response (PDF/DOC)</label>
                                    <input type="file" id="submissionFile" name="file" required accept=".pdf,.doc,.docx">
                                </div>
                                <button type="submit" class="btn btn-primary">Submit</button>
                            </form>
                        </div>
                    `;
                case 'form':
                    return `
                        <div class="submission-form">
                            <p>Please complete the form and submit your response:</p>
                            <a href="${task.formLink}" target="_blank" class="btn btn-primary">Open Form</a>
                            ${task.submissionStatus === 'pending' ? `<button onclick="submitFormTask('${task._id}')" class="btn btn-success ml-2">Mark as Completed</button>` : ''}
                        </div>
                    `;
                case 'hackathon':
                    return `
                        <div class="submission-form">
                            <form onsubmit="submitHackathonSubmission(event, '${task._id}')">
                                <div class="form-group">
                                    <label for="projectLink">Project Link</label>
                                    <input type="url" id="projectLink" name="projectLink" required>
                                </div>
                                <div class="form-group">
                                    <label for="teamDetails">Team Details</label>
                                    <textarea id="teamDetails" name="teamDetails" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="achievements">Achievements</label>
                                    <textarea id="achievements" name="achievements"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Submit</button>
                            </form>
                        </div>
                    `;
                case 'quiz':
                    return `
                        <div class="submission-form">
                            <p>Please complete the quiz and submit your score:</p>
                            <a href="${task.quizDetails.quizLink}" target="_blank" class="btn btn-primary">Take Quiz</a>
                            <form onsubmit="submitQuizScore(event, '${task._id}')" class="mt-3">
                                <div class="form-group">
                                    <label for="quizScore">Your Score</label>
                                    <input type="number" id="quizScore" name="quizScore" required min="0" max="${task.quizDetails.totalQuestions}">
                                </div>
                                <button type="submit" class="btn btn-primary">Submit Score</button>
                            </form>
                        </div>
                    `;
                case 'project':
                    return `
                        <div class="submission-form">
                            <form onsubmit="submitProjectSubmission(event, '${task._id}')">
                                <div class="form-group">
                                    <label for="deliverables">Deliverables</label>
                                    <input type="text" id="deliverables" name="deliverables" required placeholder="Comma-separated list of deliverables">
                                </div>
                                <div class="form-group">
                                    <label for="documentation">Documentation</label>
                                    <textarea id="documentation" name="documentation" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="demoLink">Demo Link</label>
                                    <input type="url" id="demoLink" name="demoLink">
                                </div>
                                <button type="submit" class="btn btn-primary">Submit Project</button>
                            </form>
                        </div>
                    `;
                default:
                    return '';
            }
        }

        async function submitTask(event, taskId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch(`http://localhost:5000/api/tasks/${taskId}/submit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Task submitted successfully!');
                    // Reload tasks with the current user
                    const user = JSON.parse(localStorage.getItem('user') || '{}');
                    await loadTasks(user);
                } else {
                    const error = await response.json();
                    alert(error.message || 'Error submitting task');
                }
            } catch (error) {
                console.error('Error submitting task:', error);
                alert('Error submitting task');
            }
        }

        async function submitHackathonSubmission(event, taskId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch(`http://localhost:5000/api/tasks/${taskId}/submit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        projectLink: formData.get('projectLink'),
                        teamDetails: formData.get('teamDetails'),
                        achievements: formData.get('achievements')
                    })
                });

                if (response.ok) {
                    alert('Hackathon submission successful!');
                    loadTasks();
                } else {
                    const error = await response.json();
                    alert(error.message || 'Error submitting hackathon');
                }
            } catch (error) {
                alert('Error submitting hackathon');
            }
        }

        async function submitQuizScore(event, taskId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch(`http://localhost:5000/api/tasks/${taskId}/submit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        quizScore: parseInt(formData.get('quizScore'))
                    })
                });

                if (response.ok) {
                    alert('Quiz score submitted successfully!');
                    loadTasks();
                } else {
                    const error = await response.json();
                    alert(error.message || 'Error submitting quiz score');
                }
            } catch (error) {
                alert('Error submitting quiz score');
            }
        }

        async function submitProjectSubmission(event, taskId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch(`http://localhost:5000/api/tasks/${taskId}/submit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        deliverables: formData.get('deliverables').split(','),
                        documentation: formData.get('documentation'),
                        demoLink: formData.get('demoLink')
                    })
                });

                if (response.ok) {
                    alert('Project submitted successfully!');
                    loadTasks();
                } else {
                    const error = await response.json();
                    alert(error.message || 'Error submitting project');
                }
            } catch (error) {
                alert('Error submitting project');
            }
        }

        // Function to handle form task submission
        async function submitFormTask(taskId) {
            try {
                const response = await fetch(`http://localhost:5000/api/tasks/${taskId}/submit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ // Send empty body or a flag indicating completion
                         status: 'submitted' // Indicate completion
                    })
                });

                if (response.ok) {
                    alert('Form task marked as completed!');
                    // Reload tasks with the current user to update the status
                    const user = JSON.parse(localStorage.getItem('user') || '{}');
                    await loadTasks(user);
                } else {
                    const error = await response.json();
                    alert(error.message || 'Error marking form as completed');
                }
            } catch (error) {
                console.error('Error marking form task as completed:', error);
                alert('Error marking form task as completed');
            }
        }

        // Logout function
        window.logout = function() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.replace('http://localhost:5000/login');
        };

        // Load upcoming events
        async function loadEvents() {
            try {
                const response = await fetch('http://localhost:5000/api/events/upcoming', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const events = await response.json();
                displayEvents(events);
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }

        // Display events in the list
        function displayEvents(events) {
            const eventsList = document.getElementById('eventsList');
            eventsList.innerHTML = events.map(event => `
                <div class="event-card">
                    <h4>${event.title}</h4>
                    <p>${event.description}</p>
                    <p>Deadline: ${new Date(event.deadline).toLocaleString()}</p>
                    <div class="event-status">
                        ${event.isRegistered ? 
                            '<span class="badge badge-success">Registered</span>' : 
                            new Date(event.deadline) < new Date() ?
                                '<span class="badge badge-danger">Closed</span>' :
                                `<button onclick="registerForEvent('${event._id}')" class="btn btn-primary">Register</button>`
                        }
                    </div>
                    ${event.formLink ? `<a href="${event.formLink}" target="_blank" class="btn btn-info">View Form</a>` : ''}
                </div>
            `).join('');
        }

        // Register for an event
        async function registerForEvent(eventId) {
            try {
                const response = await fetch('http://localhost:5000/api/events/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ eventId })
                });

                if (response.ok) {
                    alert('Successfully registered for the event!');
                    loadEvents(); // Refresh the events list
                } else {
                    const error = await response.json();
                    alert(error.message);
                }
            } catch (error) {
                console.error('Error registering for event:', error);
                alert('Error registering for event');
            }
        }

        // Initialize the dashboard when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            initDashboard();
            loadEvents();
        });
    </script>
</body>
</html> 